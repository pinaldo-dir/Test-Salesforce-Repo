<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>59.0</apiVersion>
    <assignments>
        <name>Add_Update_KVS_to_Collection</name>
        <label>Add Updated KVS to Collection</label>
        <locationX>1449</locationX>
        <locationY>493</locationY>
        <assignmentItems>
            <assignToReference>varKVSRecords</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_KVS</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_KVS</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_Updated_User_to_Collection</name>
        <label>Add Updated User to Collection</label>
        <locationX>1598</locationX>
        <locationY>775</locationY>
        <assignmentItems>
            <assignToReference>varUpdatedUserAccounts</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_User_Accounts_to_Update</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_User_Accounts_to_Update</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Save_Post_Refresh_Counter_Value</name>
        <label>Save Post Refresh Counter Value</label>
        <locationX>1443</locationX>
        <locationY>644</locationY>
        <assignmentItems>
            <assignToReference>varPreviousPostRefreshCounterValue</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>Loop_KVS.Value__c</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Set_Post_Refresh_Counter_To_1</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_Post_Refresh_Counter_To_1</name>
        <label>Set Post Refresh Counter To 1</label>
        <locationX>1689</locationX>
        <locationY>293</locationY>
        <assignmentItems>
            <assignToReference>Loop_KVS.Value__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>1</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Update_KVS_to_Collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_User_Account_Email</name>
        <label>Set User Account Email</label>
        <locationX>1602</locationX>
        <locationY>947</locationY>
        <assignmentItems>
            <assignToReference>Loop_User_Accounts_to_Update.Email</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varUserAccountEmailUpdate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Updated_User_to_Collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>setBaseURL</name>
        <label>setBaseURL</label>
        <locationX>1222</locationX>
        <locationY>292</locationY>
        <assignmentItems>
            <assignToReference>Loop_KVS.Value__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varPartnerBaseURL</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Update_KVS_to_Collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>setCommunityUserIDSuffix</name>
        <label>setCommunityUserIDSuffix</label>
        <locationX>1369</locationX>
        <locationY>298</locationY>
        <assignmentItems>
            <assignToReference>Loop_KVS.Value__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varCommunityUserIDSuffix</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Update_KVS_to_Collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>setRSCommunityBaseURL</name>
        <label>setRSCommunityBaseURL</label>
        <locationX>1536</locationX>
        <locationY>298</locationY>
        <assignmentItems>
            <assignToReference>Loop_KVS.Value__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>varRSCommunityBaseURL</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_Update_KVS_to_Collection</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Check_KVS_Items</name>
        <label>Check KVS Items</label>
        <locationX>1224</locationX>
        <locationY>450</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>isPostRefreshCounter</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_KVS.Name</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>PostRefreshCounter</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Check_Post_Refresh_Counter_Value</targetReference>
            </connector>
            <label>isPostRefreshCounter</label>
        </rules>
        <rules>
            <name>isBaseURL</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_KVS.Name</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>BaseURL</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>setBaseURL</targetReference>
            </connector>
            <label>isBaseURL</label>
        </rules>
        <rules>
            <name>isCommunityUserIDSuffix</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_KVS.Name</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>Community UserID Suffix</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>setCommunityUserIDSuffix</targetReference>
            </connector>
            <label>isCommunityUserIDSuffix</label>
        </rules>
        <rules>
            <name>isRSCommunityBaseURL</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_KVS.Name</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>RS Community Base URL</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>setRSCommunityBaseURL</targetReference>
            </connector>
            <label>isRSCommunityBaseURL</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Org_ID</name>
        <label>Check Org ID</label>
        <locationX>768</locationX>
        <locationY>311</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>isSandbox</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varPartnerURLSandbox</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_KVS_Records</targetReference>
            </connector>
            <label>isSandbox</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Post_Refresh_Counter_Value</name>
        <label>Check Post Refresh Counter Value</label>
        <locationX>1227</locationX>
        <locationY>601</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>isValue0</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>Loop_KVS.Value__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>0</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Save_Post_Refresh_Counter_Value</targetReference>
            </connector>
            <label>isValue0</label>
        </rules>
    </decisions>
    <decisions>
        <name>Check_Sandbox</name>
        <label>Check Sandbox</label>
        <locationX>1045</locationX>
        <locationY>764</locationY>
        <defaultConnectorLabel>Default Outcome</defaultConnectorLabel>
        <rules>
            <name>isDEVQA</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>varPartnerURLSandbox</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>devqa</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_User_Admin_to_Update</targetReference>
            </connector>
            <label>isDEVQA</label>
        </rules>
        <rules>
            <name>isUAT</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varPartnerURLSandbox</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>uat</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Admin_And_SME_Records</targetReference>
            </connector>
            <label>isUAT</label>
        </rules>
        <rules>
            <name>isINT</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varPartnerURLSandbox</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>int</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_User_Admin_to_Update</targetReference>
            </connector>
            <label>isINT</label>
        </rules>
        <rules>
            <name>isDEVCODE</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>varPartnerURLSandbox</leftValueReference>
                <operator>Contains</operator>
                <rightValue>
                    <stringValue>devcode</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Permission_Set</targetReference>
            </connector>
            <label>isDEVCODE</label>
        </rules>
    </decisions>
    <description>Activate Admin, SME, update other email accounts, metadata settings</description>
    <environments>Default</environments>
    <formulas>
        <name>varCommunityUserIDSuffix</name>
        <dataType>String</dataType>
        <expression>&apos;.reg&apos; + {!varPartnerURLSandbox}</expression>
    </formulas>
    <formulas>
        <name>varPartner590URL</name>
        <dataType>String</dataType>
        <expression>{!$Api.Partner_Server_URL_590}</expression>
    </formulas>
    <formulas>
        <name>varPartnerBaseURL</name>
        <dataType>String</dataType>
        <expression>LEFT({!$Api.Partner_Server_URL_590}, FIND(&apos;/services&apos;, {!$Api.Partner_Server_URL_590}))</expression>
    </formulas>
    <formulas>
        <name>varPartnerURLSandbox</name>
        <dataType>String</dataType>
        <expression>MID({!$Api.Partner_Server_URL_590}, FIND(&apos;--&apos;,{!$Api.Partner_Server_URL_590})+2, FIND(&apos;.sandbox&apos;, {!$Api.Partner_Server_URL_590})-(FIND(&apos;--&apos;,{!$Api.Partner_Server_URL_590})+2))</expression>
    </formulas>
    <formulas>
        <name>varRSCommunityBaseURL</name>
        <dataType>String</dataType>
        <expression>LEFT({!$Api.Partner_Server_URL_590}, FIND(&apos;/services&apos;, {!$Api.Partner_Server_URL_590})) &amp; &apos;registrations&apos;</expression>
    </formulas>
    <formulas>
        <name>varUserAccountEmailUpdate</name>
        <dataType>String</dataType>
        <expression>SUBSTITUTE({!Loop_User_Accounts_to_Update.Email}, &quot;.invalid&quot;, &quot;&quot;)</expression>
    </formulas>
    <interviewLabel>Post Refresh Update {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Post Refresh Update</label>
    <loops>
        <name>Loop_KVS</name>
        <label>Loop KVS</label>
        <locationX>1051</locationX>
        <locationY>438</locationY>
        <collectionReference>varKeyValueStoreItems</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Check_KVS_Items</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_KVS_Records</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_User_Accounts_to_Update</name>
        <label>Loop User Accounts to Update</label>
        <locationX>1421</locationX>
        <locationY>847</locationY>
        <collectionReference>varUserAccountsToUpdate</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Set_User_Account_Email</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Update_User_Accounts</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>FREE_FORM_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordDeletes>
        <name>Delete_Permission_Set_Assignment</name>
        <label>Delete Permission Set Assignment</label>
        <locationX>836</locationX>
        <locationY>1352</locationY>
        <inputReference>Get_Permission_Set_Assignment</inputReference>
    </recordDeletes>
    <recordLookups>
        <name>Get_Admin_And_SME_Records</name>
        <label>Get Admin And SME Records</label>
        <locationX>1051</locationX>
        <locationY>930</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_User_Accounts_to_Update</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND 6 AND 7 AND ((3 OR 4) OR 5)</filterLogic>
        <filters>
            <field>IsActive</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Email</field>
            <operator>Contains</operator>
            <value>
                <stringValue>invalid</stringValue>
            </value>
        </filters>
        <filters>
            <field>ProfileId</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>00ed00000013xgX</stringValue>
            </value>
        </filters>
        <filters>
            <field>ProfileId</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>00et0000000UBtg</stringValue>
            </value>
        </filters>
        <filters>
            <field>isSME__c</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>005d0000002XHIg</stringValue>
            </value>
        </filters>
        <filters>
            <field>Do_NOT_Freeze__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>User</object>
        <outputReference>varUserAccountsToUpdate</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Email</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_KVS_Records</name>
        <label>Get KVS Records</label>
        <locationX>1054</locationX>
        <locationY>306</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_KVS</targetReference>
        </connector>
        <filterLogic>or</filterLogic>
        <filters>
            <field>Name</field>
            <operator>Contains</operator>
            <value>
                <stringValue>Community UserID Suffix</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>Contains</operator>
            <value>
                <stringValue>RS Community Base URL</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>Contains</operator>
            <value>
                <stringValue>BaseURL</stringValue>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>Contains</operator>
            <value>
                <stringValue>PostRefreshCounter</stringValue>
            </value>
        </filters>
        <object>Key_Value_Store__c</object>
        <outputReference>varKeyValueStoreItems</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Name</queriedFields>
        <queriedFields>Value__c</queriedFields>
    </recordLookups>
    <recordLookups>
        <description>Single Sign On</description>
        <name>Get_Permission_Set</name>
        <label>Get Permission Set</label>
        <locationX>834</locationX>
        <locationY>1058</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Get_Permission_Set_Assignment</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Single_Sign_On</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>PermissionSet</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_Permission_Set_Assignment</name>
        <label>Get Permission Set Assignment</label>
        <locationX>836</locationX>
        <locationY>1199</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Delete_Permission_Set_Assignment</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>PermissionSetId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>Get_Permission_Set.Id</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>PermissionSetAssignment</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_User_Admin_to_Update</name>
        <label>Get User Admin to Update</label>
        <locationX>1216</locationX>
        <locationY>771</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_User_Accounts_to_Update</targetReference>
        </connector>
        <filterLogic>1 AND 2 AND 5 AND 6 AND (3 OR 4)</filterLogic>
        <filters>
            <field>IsActive</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Email</field>
            <operator>Contains</operator>
            <value>
                <stringValue>invalid</stringValue>
            </value>
        </filters>
        <filters>
            <field>ProfileId</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>00ed00000013xgX</stringValue>
            </value>
        </filters>
        <filters>
            <field>ProfileId</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>00et0000000UBtg</stringValue>
            </value>
        </filters>
        <filters>
            <field>Id</field>
            <operator>NotEqualTo</operator>
            <value>
                <stringValue>005d0000002XHIg</stringValue>
            </value>
        </filters>
        <filters>
            <field>Do_NOT_Freeze__c</field>
            <operator>NotEqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>User</object>
        <outputReference>varUserAccountsToUpdate</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Email</queriedFields>
    </recordLookups>
    <recordUpdates>
        <name>Update_KVS_Records</name>
        <label>Update KVS Records</label>
        <locationX>1053</locationX>
        <locationY>606</locationY>
        <connector>
            <targetReference>Check_Sandbox</targetReference>
        </connector>
        <inputReference>varKVSRecords</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_User_Accounts</name>
        <label>Update User Accounts</label>
        <locationX>1419</locationX>
        <locationY>1058</locationY>
        <connector>
            <targetReference>Get_Permission_Set</targetReference>
        </connector>
        <inputReference>varUpdatedUserAccounts</inputReference>
    </recordUpdates>
    <start>
        <locationX>650</locationX>
        <locationY>48</locationY>
        <connector>
            <targetReference>Check_Org_ID</targetReference>
        </connector>
        <schedule>
            <frequency>Daily</frequency>
            <startDate>2024-02-07</startDate>
            <startTime>07:30:00.000Z</startTime>
        </schedule>
        <triggerType>Scheduled</triggerType>
    </start>
    <status>Active</status>
    <variables>
        <name>varKeyValueStoreItems</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Key_Value_Store__c</objectType>
    </variables>
    <variables>
        <name>varKVSLabelValue</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Labels__c</objectType>
    </variables>
    <variables>
        <name>varKVSRecords</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Key_Value_Store__c</objectType>
    </variables>
    <variables>
        <name>varPreviousPostRefreshCounterValue</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>varUpdatedUserAccounts</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>User</objectType>
    </variables>
    <variables>
        <name>varUserAccountsToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>User</objectType>
    </variables>
</Flow>
